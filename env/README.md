# env/ (Local Dev Sources)

This folder contains the repo-level single sources of truth for local
development configuration.

Important: files under `env/` are **not** read by Next.js or Wrangler directly.
They are synced into per-app/per-worker files by scripts.

## Standard Workflow (Recommended)

```bash
pnpm env:generate
cp env/.env.example env/.env
cp env/.vars.example env/.vars
pnpm env:bootstrap
pnpm check
```

## Files

- `env/.env.example`
  - Auto-generated by `pnpm env:generate`
  - Template for `env/.env` (includes all env keys, including secrets)
- `env/.env`
  - Your local values (gitignored)
  - Used to generate per-target dotenv files for the dashboard and workers
- `env/.vars.example`
  - Auto-generated by `pnpm env:generate`
  - Template for `env/.vars` (Wrangler non-secret vars; supports boolean/number)
- `env/.vars`
  - Your local values (gitignored)
  - Used to update `wrangler.jsonc` `"vars"` and `"env"."production"."vars"`

## Commands & How It Works

### 1) `pnpm env:generate`

Generates example/template files to keep keys in sync:

- `apps/app/.env.example`
- `apps/workers/auth/.dev.vars.example`
- `apps/workers/v0/.dev.vars.example`
- `env/.env.example`
- `env/.vars.example`

Sources:

- dotenv env manifest: `packages/runtime/src/env.ts`
- Wrangler vars manifest: `packages/runtime/src/vars.ts`

### 2) `pnpm env:sync:local`

Reads `env/.env` and writes/updates:

- `apps/app/.env`
- `apps/workers/auth/.dev.vars` (secrets only)
- `apps/workers/v0/.dev.vars` (secrets only)

Implementation: `scripts/env/sync-local-env.ts`

Constraint:

- Workers `.dev.vars` must contain secrets only. Non-secrets should live in
  Wrangler vars (`wrangler.jsonc`) so typegen keeps boolean/number bindings
  typed (instead of widening them to `string`).

### 3) `pnpm env:sync:vars`

Reads `env/.vars` and writes/updates:

- `apps/workers/auth/wrangler.jsonc`
  - root `"vars"`
  - `"env"."production"."vars"`
- `apps/workers/v0/wrangler.jsonc`
  - root `"vars"`
  - `"env"."production"."vars"`

Implementation: `scripts/env/sync-to-vars.ts`

Fallback:

- If `env/.vars` is missing, the script falls back to `env/.env` (or `env/.env.local`)
  for **local** values only.
- For production overrides, create `env/.vars` and use `PRODUCTION__*` entries.

Rules:

- `.vars` uses dotenv format
- `KEY=value` writes to root `wrangler.jsonc` `"vars"`
- `PRODUCTION__KEY=value` writes to `wrangler.jsonc` `"env"."production"."vars"`
- Values are coerced based on `packages/runtime/src/vars.ts`:
  - `boolean` must be `true/false`
  - `number` must be a valid number

### 4) `pnpm env:bootstrap`

Runs both sync steps in order:

1. `pnpm env:sync:local`
2. `pnpm env:sync:vars`

Implementation: `scripts/env/bootstrap-env-vars.ts`

### 5) `pnpm check`

Local entrypoint intended to align with GitHub Validate:

- `biome ci .`
- dashboard ESLint
- workspace typecheck
- SDK tests + build

Implementation: root `package.json` `check` / `check:ci`.
